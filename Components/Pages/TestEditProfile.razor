@page "/edit-profile"
@using System.Net.Http
@using System.Net.Http.Json
@using System.Text.Json
@using CSE325_team.Models


@inject HttpClient Http
@inject IHttpClientFactory HttpClientFactory
@inject NavigationManager NavManager

<EditForm Model="EditModel" OnValidSubmit="HandleValidSubmit" >
    <DataAnnotationsValidator />
    <ValidationSummary />

    <h3> Edit Profile Test Page</h3>

    <div class="form-group">
        <label>First Name</label>
        <InputText @bind-Value="EditModel.FirstName" class="form-control" />        
    </div>
    <div class="form-group">
        <label>Last Name</label>
        <InputText @bind-Value="EditModel.LastName" class="form-control" />
    </div>
    <div class="form-group">
        <label>Phone Number</label>
        <InputText @bind-Value="EditModel.PhoneNumber" class="form-control" />
    </div>
    <div class="form-group">
        <label>Alternate Phone Number</label>
        <InputText @bind-Value="EditModel.AltPhoneNumber" class="form-control" />
    </div>
    <div class="form-group">
        <label>City</label>
        <InputText @bind-Value="EditModel.City" class="form-control" />
    </div>

    <button class="btn btn-primary" type="submit">Save Changes</button>


</EditForm>

@code {

    private UserContactCombined EditModel = new();

    protected override async Task OnInitializedAsync()
    {
        //api/UserProfile comes from the Controller file "UserProfileController.cs" less the Controller 
        EditModel = await Http.GetFromJsonAsync<UserContactCombined>("api/UserProfile");

//test block
        var client = HttpClientFactory.CreateClient();
        client.BaseAddress = new Uri(NavManager.BaseUri);

        try
        {
            var response = await client.GetAsync("api/UserProfile");
            var body = await response.Content.ReadAsStringAsync();

            Console.WriteLine("Status Code: " + response.StatusCode);
            Console.WriteLine("Body: " + body);

            if (!response.IsSuccessStatusCode)
            {
                throw new Exception("Request failed: " + body);
            }

            EditModel = JsonSerializer.Deserialize<UserContactCombined>(body);

        }
        catch (Exception exc)
        {
            Console.WriteLine("-------Error calling API: " + exc.Message);
        }

    //end test block

    }

    private async Task HandleValidSubmit()
    {
        var response = await Http.PutAsJsonAsync("api/UserProfile", EditModel);
        if (response.IsSuccessStatusCode)
        {
            Console.WriteLine("***************Update succeeded");
        }
        else{
            Console.WriteLine("*****************Update failed.");
        }

    }


    public class UserContactCombined
    {
        public string? Id {get; set;}
        public string? FirstName {get;set;}
        public string? LastName {get;set;}
        public string? PhoneNumber {get; set;}
        public string? AltPhoneNumber {get;set;}
        public string? City {get; set;}
    }

}